(function(document, window, $) {
	'use strict';

	$('#choose-appointment-drop').on('change', function() {
		var selected = $(this).val();
		$('#app-date-picker').val('');
		$.ajax({
			url: "../ajax.php", 
			type: 'POST',
			data:{
				'type': 'getAppDefDetails',
				'appId': selected
			},
			success: function(result){
	        	$('#selected-app').val(selected);
	    	}
		});
	});

	if( $('#app-date-picker').length ) {
      $('#app-date-picker').datepicker({
          format: 'yyyy/mm/dd',
          startDate: new Date() + 1,
          autoclose: true,
      });

      $('#app-date-picker').on('change', function() {
      	var selected_Date = $('#app-date-picker').val();
      	$('#payment-model-gen').prop('disabled', true);
      	$('.app-messgae').html('');
      	$.ajax({
			url: "../ajax.php", 
			type: 'POST',
			data:{
				'type': 'checkAppAvailable',
				'selected_date': selected_Date,
				'appdef_id': $('#choose-appointment-drop').val()
			},
			success: function(result){
				if( result == 'available' ) {
					$('#payment-model-gen').prop('disabled', false);
					$('.app-messgae').html();
				} else if( result == 'exceeded' ) {
      				$('#payment-model-gen').prop('disabled', true);
					$('.app-messgae').html('<div class="alert alert-danger alert-dismissible" role="alert">Sorry Appointment filledup!</div>');
				} else if( result == 'already' ) {
					$('#payment-model-gen').prop('disabled', true);
					$('.app-messgae').html('<div class="alert alert-info alert-dismissible" role="alert">Sorry you have already taken this appointment!Please choose another date!</div>');
				}
				console.log(result);
			}
		});
      })

    }

	$('#doPayPayment').on('click', function(){
		if( $('.modal-content .has-success').length == 4 ) {

			var number = $('#cardtextBox1').val() + $('#cardtextBox2').val() + $('#cardtextBox3').val() + $('#cardtextBox4').val();
			$('#doPayPayment').prop('disabled', true);
			$('.app-messgae').html();
			$.ajax({
				url: "../ajax.php", 
				type: 'POST',
				data:{
					'type': 'doPayment',
					'card_no': number,
					'amount': $('.payable-price-label').html(),
					'appdef_id': $('#choose-appointment-drop').val(),
					'selected_date': $('#app-date-picker').val()
				},
				success: function(result){
		        	console.log(result);
		        	if( result == 'success' ) {
		        		$('#doPayPayment').prop('disabled', true);
		        		$('.custom-message').html('<span class="success">Payed Successfully!</span>');
		        		setTimeout(function() {
						    $('#model-close-btn').trigger('click');
						}, 2000);
						$('.app-messgae').html('<div class="alert alert-success alert-dismissible" role="alert">Appointment taken successfully! on ' + $('#app-date-picker').val() + '</div>');
		        	} else if( result == 'invalid' ) {
		        		$('#doPayPayment').prop('disabled', false);
		        		$('.custom-message').html('<span class="error">Invalid card number!</span>');
		        	} else if( result == 'exceeded' ) {
		        		$('#doPayPayment').prop('disabled', false);
		        		$('.custom-message').html('<span class="error">Sorry patients exceeded!Please choose another appointment!</span>');
		        	} else {
		        		$('#doPayPayment').prop('disabled', false);
		        	}
		    	}
			});
		}
	})
	$("#card-form").submit(function(e) {
	    e.preventDefault();
	});

	$('#payment-model-gen').on('click', function(){
		console.log($('#choose-appointment-drop').val());
		console.log($('#app-date-picker').val());
		if( $('#choose-appointment-drop').val() != 'Choose an Appointment' && $('#app-date-picker').val() != "" ) {
			$('#paymentModelBox').modal('show');
		} else {
			toastr.error('Please fillup all fields!');
		}
	});

})(document, window, jQuery);